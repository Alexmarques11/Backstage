# DigitalOcean Database Setup Guide

This guide explains how to create and configure 5 separate PostgreSQL databases in DigitalOcean for the Backstage microservices architecture.

## Overview

The Backstage platform uses a microservices architecture with **5 separate databases**:

1. **Publication Database** - Stores posts and concert creation data
2. **Auth Database** - Manages user authentication and profiles
3. **Passport Database** - Tracks concert passports and user statistics
4. **Market Database** - Handles ticket marketplace listings and transactions
5. **Events Database** - Aggregates external events from APIs

## Database Creation Steps

### Option 1: Using DigitalOcean Web Console

1. **Log in to DigitalOcean Console**
   - Navigate to: https://cloud.digitalocean.com/

2. **Create Each Database**
   
   For each of the 5 databases, repeat these steps:

   - Click **"Create"** → **"Databases"**
   - Choose **PostgreSQL** as the database engine
   - Select your preferred version (recommended: PostgreSQL 15 or higher)
   - Choose a datacenter region (use the same region as your Kubernetes cluster)
   - Select a database plan:
     - **Development**: Basic plan with 1GB RAM
     - **Production**: Professional plan with 4GB+ RAM
   - Set the database cluster name:
     - `backstage-publication-db`
     - `backstage-auth-db`
     - `backstage-passport-db`
     - `backstage-market-db`
     - `backstage-events-db`
   - Click **"Create Database Cluster"**
   - Wait for provisioning (2-5 minutes per database)

3. **Configure Each Database**
   
   After each database is created:
   - Go to the database settings
   - Under **"Users & Databases"** tab:
     - The default `doadmin` user will be created automatically
     - Create a dedicated database within the cluster:
       - `publication_db`
       - `auth_db`
       - `passport_db`
       - `market_db`
       - `events_db`
   - Under **"Connection Details"** tab:
     - Note down the connection information (host, port, username, password)
     - Port is typically `25060` (DigitalOcean's default for managed databases)

4. **Add Trusted Sources**
   - Under **"Settings"** → **"Trusted Sources"**
   - Add your Kubernetes cluster's VPC or nodes
   - Or add specific IP addresses that need access

### Option 2: Using DigitalOcean CLI (doctl)

```bash
# Install doctl if not already installed
# https://docs.digitalocean.com/reference/doctl/how-to/install/

# Authenticate
doctl auth init

# Get available regions
doctl databases options regions

# Get available database sizes
doctl databases options sizes

# Create Publication Database
doctl databases create backstage-publication-db \
  --engine pg \
  --version 15 \
  --region nyc3 \
  --size db-s-1vcpu-1gb

# Create Auth Database
doctl databases create backstage-auth-db \
  --engine pg \
  --version 15 \
  --region nyc3 \
  --size db-s-1vcpu-1gb

# Create Passport Database
doctl databases create backstage-passport-db \
  --engine pg \
  --version 15 \
  --region nyc3 \
  --size db-s-1vcpu-1gb

# Create Market Database
doctl databases create backstage-market-db \
  --engine pg \
  --version 15 \
  --region nyc3 \
  --size db-s-1vcpu-1gb

# Create Events Database
doctl databases create backstage-events-db \
  --engine pg \
  --version 15 \
  --region nyc3 \
  --size db-s-1vcpu-1gb

# Wait for databases to be provisioned
# Check status with:
doctl databases list

# Create dedicated database within each cluster
# Get the database ID from the list command above

doctl databases db create <publication-db-id> publication_db
doctl databases db create <auth-db-id> auth_db
doctl databases db create <passport-db-id> passport_db
doctl databases db create <market-db-id> market_db
doctl databases db create <events-db-id> events_db
```

## Gathering Connection Details

For each database, you'll need the following information:

1. **Host** (e.g., `backstage-publication-db-do-user-123456-0.b.db.ondigitalocean.com`)
2. **Port** (typically `25060`)
3. **Username** (typically `doadmin`)
4. **Password** (generated by DigitalOcean)
5. **Database Name** (e.g., `publication_db`, `auth_db`, etc.)

### Get Connection Info via CLI

```bash
# List all databases to get their IDs
doctl databases list

# Get connection details for each database
doctl databases connection <database-id>

# Or get all info in one command
doctl databases get <database-id>
```

## Setting Up GitHub Secrets

Once all databases are created, add their connection details to GitHub Secrets:

1. **Navigate to GitHub Repository Settings**
   - Go to: `https://github.com/Alexmarques11/Backstage/settings/secrets/actions`

2. **Add the following secrets** (25 database secrets + 2 JWT secrets):

### Publication Database Secrets
```
DO_PUBLICATION_DB_HOST=<host-from-digitalocean>
DO_PUBLICATION_DB_PORT=25060
DO_PUBLICATION_DB_USER=doadmin
DO_PUBLICATION_DB_PASSWORD=<password-from-digitalocean>
DO_PUBLICATION_DB_NAME=publication_db
```

### Auth Database Secrets
```
DO_AUTH_DB_HOST=<host-from-digitalocean>
DO_AUTH_DB_PORT=25060
DO_AUTH_DB_USER=doadmin
DO_AUTH_DB_PASSWORD=<password-from-digitalocean>
DO_AUTH_DB_NAME=auth_db
```

### Passport Database Secrets
```
DO_PASSPORT_DB_HOST=<host-from-digitalocean>
DO_PASSPORT_DB_PORT=25060
DO_PASSPORT_DB_USER=doadmin
DO_PASSPORT_DB_PASSWORD=<password-from-digitalocean>
DO_PASSPORT_DB_NAME=passport_db
```

### Market Database Secrets
```
DO_MARKET_DB_HOST=<host-from-digitalocean>
DO_MARKET_DB_PORT=25060
DO_MARKET_DB_USER=doadmin
DO_MARKET_DB_PASSWORD=<password-from-digitalocean>
DO_MARKET_DB_NAME=market_db
```

### Events Database Secrets
```
DO_EVENTS_DB_HOST=<host-from-digitalocean>
DO_EVENTS_DB_PORT=25060
DO_EVENTS_DB_USER=doadmin
DO_EVENTS_DB_PASSWORD=<password-from-digitalocean>
DO_EVENTS_DB_NAME=events_db
```

### JWT Secrets (if not already created)
```bash
# Generate secure random secrets
DO_ACCESS_TOKEN_SECRET=$(openssl rand -base64 64)
DO_REFRESH_TOKEN_SECRET=$(openssl rand -base64 64)
```

Add them to GitHub Secrets:
```
DO_ACCESS_TOKEN_SECRET=<generated-access-token>
DO_REFRESH_TOKEN_SECRET=<generated-refresh-token>
```

## Initializing Database Tables

After deployment, initialize each database schema by calling the `/setup` endpoint:

```bash
# Get the node IP from your Kubernetes cluster
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')

# Initialize Auth Database (creates users table)
curl -X GET http://$NODE_IP:30002/setup

# Initialize Publication Database (if needed)
curl -X GET http://$NODE_IP:30001/setup

# Initialize Passport Database (creates concert_passports and statistics tables)
curl -X GET http://$NODE_IP:30003/setup

# Initialize Market Database (creates listings and transactions tables)
curl -X GET http://$NODE_IP:30004/setup

# Initialize Events Database (creates external_events tables)
curl -X GET http://$NODE_IP:30005/setup
```

## Service Port Mapping

| Service | Internal Port | NodePort | Database |
|---------|--------------|----------|----------|
| Server (Publications) | 3000 | 30001 | publication_db, auth_db |
| Auth | 4000 | 30002 | auth_db |
| Passport | 5000 | 30003 | passport_db |
| Market | 6000 | 30004 | market_db |
| Events | 7000 | 30005 | events_db |

## Testing Database Connectivity

Test each database connection from your local machine or Kubernetes pod:

```bash
# Install psql client if needed
# Ubuntu/Debian: sudo apt-get install postgresql-client
# macOS: brew install postgresql

# Test Publication Database
psql "postgresql://doadmin:<password>@<host>:25060/publication_db?sslmode=require"

# Test Auth Database
psql "postgresql://doadmin:<password>@<host>:25060/auth_db?sslmode=require"

# Test Passport Database
psql "postgresql://doadmin:<password>@<host>:25060/passport_db?sslmode=require"

# Test Market Database
psql "postgresql://doadmin:<password>@<host>:25060/market_db?sslmode=require"

# Test Events Database
psql "postgresql://doadmin:<password>@<host>:25060/events_db?sslmode=require"
```

## Cost Estimation

### Development Environment
- **Basic Plan** (1GB RAM, 10GB disk): **$15/month per database**
- **Total for 5 databases**: **$75/month**

### Production Environment
- **Professional Plan** (4GB RAM, 115GB disk): **$120/month per database**
- **Total for 5 databases**: **$600/month**

### Cost Optimization Tips
1. **Start with Basic plans** for development/testing
2. **Use the same database cluster** with multiple databases if budget is tight:
   - Create 1 database cluster
   - Create 5 separate databases within that cluster
   - **Cost**: $15-120/month (depending on plan)
   - **Trade-off**: Less isolation, single point of failure
3. **Scale individual databases** based on actual usage patterns
4. **Enable automatic backups** (included in the price)
5. **Monitor database metrics** to right-size your plan

## Database Monitoring

DigitalOcean provides built-in monitoring for:
- CPU usage
- Memory usage
- Disk I/O
- Network traffic
- Active connections
- Query performance

Access metrics:
1. Go to your database in DigitalOcean console
2. Click **"Metrics"** tab
3. View real-time and historical data

## Backup and Recovery

### Automatic Backups
- DigitalOcean automatically creates daily backups
- Backups are retained for 7 days (Basic) or 30 days (Professional+)
- Located in the **"Backups & Restore"** tab

### Manual Backup
```bash
# Backup a database
pg_dump "postgresql://doadmin:<password>@<host>:25060/publication_db?sslmode=require" > publication_backup.sql

# Restore a database
psql "postgresql://doadmin:<password>@<host>:25060/publication_db?sslmode=require" < publication_backup.sql
```

## Security Best Practices

1. **Use SSL/TLS connections** (enabled by default)
2. **Restrict trusted sources** to only necessary IPs/VPCs
3. **Rotate passwords regularly**
4. **Use connection pooling** (already implemented in the app)
5. **Monitor for suspicious activity** via DigitalOcean metrics
6. **Keep database versions up to date**
7. **Use separate database users** for different services (optional enhancement)

## Troubleshooting

### Connection Issues
- Verify the database host and port
- Check if your IP is in trusted sources
- Ensure SSL is enabled in connection string
- Test with `psql` command line tool

### Performance Issues
- Check database metrics in DigitalOcean console
- Upgrade to a larger plan if needed
- Review slow queries in logs
- Add database indexes where necessary

### Deployment Failures
- Verify all 25 database secrets are set in GitHub
- Check Kubernetes pod logs: `kubectl logs -n backstage <pod-name>`
- Verify database names match exactly
- Ensure databases are accessible from Kubernetes cluster

## Next Steps

1. ✅ Create all 5 databases in DigitalOcean
2. ✅ Gather connection details for each database
3. ✅ Add all secrets to GitHub repository settings
4. ✅ Deploy the application (GitHub Actions will run automatically)
5. ✅ Initialize database schemas via `/setup` endpoints
6. ✅ Test each microservice endpoint
7. ✅ Monitor database performance and costs

## Support

- **DigitalOcean Docs**: https://docs.digitalocean.com/products/databases/
- **PostgreSQL Docs**: https://www.postgresql.org/docs/
- **Project Repository**: https://github.com/Alexmarques11/Backstage
