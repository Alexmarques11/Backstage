name: DigitalOcean Registry Deploy

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - '.github/workflows/docker-deploy.yml'
  release:
    types: [ published ]
  workflow_dispatch:

# Registry name is configured via DIGITALOCEAN_REGISTRY_NAME secret
# Set it to your registry name (e.g., "backstage-registry-12345")

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    env:
      REGISTRY: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}
      SERVER_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-server
      AUTH_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-auth
      PASSPORT_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-passport
      MARKET_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-market
      EVENTS_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-events
      GATEWAY_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-server
      NOTIFICATIONS_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}/backstage-server

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build and push Server
    - name: Build and push Server image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/publications/Dockerfile
        push: true
        tags: ${{ env.SERVER_IMAGE }}:latest
        cache-from: type=gha,scope=server
        cache-to: type=gha,mode=max,scope=server

    # Build and push Auth
    - name: Build and push Auth image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/authentication/Dockerfile
        push: true
        tags: ${{ env.AUTH_IMAGE }}:latest
        cache-from: type=gha,scope=auth
        cache-to: type=gha,mode=max,scope=auth

    # Build and push Passport
    - name: Build and push Passport image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/passport/Dockerfile
        push: true
        tags: ${{ env.PASSPORT_IMAGE }}:latest
        cache-from: type=gha,scope=passport
        cache-to: type=gha,mode=max,scope=passport

    # Build and push Market
    - name: Build and push Market image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/market/Dockerfile
        push: true
        tags: ${{ env.MARKET_IMAGE }}:latest
        cache-from: type=gha,scope=market
        cache-to: type=gha,mode=max,scope=market

    # Build and push Events
    - name: Build and push Events image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/events/Dockerfile
        push: true
        tags: ${{ env.EVENTS_IMAGE }}:latest
        cache-from: type=gha,scope=events
        cache-to: type=gha,mode=max,scope=events

    # Build and push Notifications (reuse server repository)
    - name: Build and push Notifications image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/notifications/Dockerfile
        push: true
        tags: ${{ env.NOTIFICATIONS_IMAGE }}:notifications
        cache-from: type=gha,scope=notifications
        cache-to: type=gha,mode=max,scope=notifications

    # Build and push Gateway (reuse server repository)
    - name: Build and push Gateway image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/gateway/Dockerfile
        push: true
        tags: ${{ env.GATEWAY_IMAGE }}:gateway
        cache-from: type=gha,scope=gateway
        cache-to: type=gha,mode=max,scope=gateway

    - name: Images pushed successfully
      run: |
        echo "‚úÖ All Docker images pushed successfully to DigitalOcean Container Registry!"
        echo ""
        echo "Images:"
        echo "  - ${{ env.SERVER_IMAGE }}:latest"
        echo "  - ${{ env.AUTH_IMAGE }}:latest"
        echo "  - ${{ env.PASSPORT_IMAGE }}:latest"
        echo "  - ${{ env.MARKET_IMAGE }}:latest"
        echo "  - ${{ env.EVENTS_IMAGE }}:latest"
        echo "  - ${{ env.GATEWAY_IMAGE }}:gateway"

  notification:
    runs-on: ubuntu-latest
    needs: [build-and-push-images]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment notification
      run: |
        echo "‚úÖ Docker images successfully built and pushed to DigitalOcean Registry!"
        echo ""
        echo "Ready to trigger DigitalOcean Kubernetes deployment..."

  deploy-to-kubernetes:
    runs-on: ubuntu-latest
    needs: [build-and-push-images]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Save DigitalOcean kubeconfig
      run: doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_ID }}

    - name: Restart deployments to pull new images
      run: |
        echo "üöÄ Restarting Kubernetes deployments..."
        kubectl rollout restart deployment/backstage-server -n backstage
        kubectl rollout restart deployment/backstage-auth -n backstage
        kubectl rollout restart deployment/backstage-passport -n backstage
        kubectl rollout restart deployment/backstage-market -n backstage
        kubectl rollout restart deployment/backstage-events -n backstage
        kubectl rollout restart deployment/backstage-notifications -n backstage
        kubectl rollout restart deployment/backstage-gateway -n backstage
        echo "‚úÖ All deployments restarted!"

    - name: Wait for rollouts to complete
      run: |
        echo "‚è≥ Waiting for rollouts to complete..."
        kubectl rollout status deployment/backstage-server -n backstage --timeout=120s || true
        kubectl rollout status deployment/backstage-auth -n backstage --timeout=120s || true
        kubectl rollout status deployment/backstage-gateway -n backstage --timeout=120s || true
        echo "‚úÖ Deployment complete!"
