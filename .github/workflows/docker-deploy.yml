name: DigitalOcean Registry Deploy

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - '.github/workflows/docker-deploy.yml'
  release:
    types: [ published ]
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com/backstage-registry-1761508031
  SERVER_IMAGE: registry.digitalocean.com/backstage-registry-1761508031/backstage-server
  AUTH_IMAGE: registry.digitalocean.com/backstage-registry-1761508031/backstage-auth
  PASSPORT_IMAGE: registry.digitalocean.com/backstage-registry-1761508031/backstage-passport
  MARKET_IMAGE: registry.digitalocean.com/backstage-registry-1761508031/backstage-market
  EVENTS_IMAGE: registry.digitalocean.com/backstage-registry-1761508031/backstage-events

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build and push Server
    - name: Build and push Server image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.server
        push: true
        tags: ${{ env.SERVER_IMAGE }}:latest
        cache-from: type=gha,scope=server
        cache-to: type=gha,mode=max,scope=server

    # Build and push Auth
    - name: Build and push Auth image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.auth
        push: true
        tags: ${{ env.AUTH_IMAGE }}:latest
        cache-from: type=gha,scope=auth
        cache-to: type=gha,mode=max,scope=auth

    # Build and push Passport
    - name: Build and push Passport image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.passport
        push: true
        tags: ${{ env.PASSPORT_IMAGE }}:latest
        cache-from: type=gha,scope=passport
        cache-to: type=gha,mode=max,scope=passport

    # Build and push Market
    - name: Build and push Market image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.market
        push: true
        tags: ${{ env.MARKET_IMAGE }}:latest
        cache-from: type=gha,scope=market
        cache-to: type=gha,mode=max,scope=market

    # Build and push Events
    - name: Build and push Events image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile.events
        push: true
        tags: ${{ env.EVENTS_IMAGE }}:latest
        cache-from: type=gha,scope=events
        cache-to: type=gha,mode=max,scope=events

    - name: Images pushed successfully
      run: |
        echo "✅ All Docker images pushed successfully to DigitalOcean Container Registry!"
        echo ""
        echo "Images:"
        echo "  - ${{ env.SERVER_IMAGE }}:latest"
        echo "  - ${{ env.AUTH_IMAGE }}:latest"
        echo "  - ${{ env.PASSPORT_IMAGE }}:latest"
        echo "  - ${{ env.MARKET_IMAGE }}:latest"
        echo "  - ${{ env.EVENTS_IMAGE }}:latest"

  notification:
    runs-on: ubuntu-latest
    needs: [build-and-push-images]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment notification
      run: |
        echo "✅ Docker images successfully built and pushed to DigitalOcean Registry!"
        echo ""
        echo "Ready to trigger DigitalOcean Kubernetes deployment..."
