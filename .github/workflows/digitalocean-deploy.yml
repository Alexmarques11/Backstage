name: Deploy to DigitalOcean Kubernetes

on:
  workflow_run:
    workflows: ["Docker Hub Deploy"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip deployment tests'
        required: false
        default: 'false'

env:
  CLUSTER_NAME: backstage-cluster
  NAMESPACE: backstage

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install doctl (DigitalOcean CLI)
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Authenticate with DigitalOcean Container Registry
      run: |
        doctl registry login

    - name: Save kubeconfig for cluster
      run: |
        doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_ID }}

    - name: Verify cluster connection
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: Create namespace if not exists
      run: |
        kubectl apply -f k8s/digitalocean/01-namespace.yaml

    - name: Create/Update secrets
      run: |
        # Delete existing secret if it exists to update it
        kubectl delete secret backstage-secrets -n $NAMESPACE --ignore-not-found=true
        
        # Create secret with all 5 database configurations + RabbitMQ
        kubectl create secret generic backstage-secrets \
          --from-literal=PUBLICATION_DB_HOST=${{ secrets.DO_PUBLICATION_DB_HOST }} \
          --from-literal=PUBLICATION_DB_PORT=${{ secrets.DO_PUBLICATION_DB_PORT }} \
          --from-literal=PUBLICATION_DB_USER=${{ secrets.DO_PUBLICATION_DB_USER }} \
          --from-literal=PUBLICATION_DB_PASSWORD=${{ secrets.DO_PUBLICATION_DB_PASSWORD }} \
          --from-literal=PUBLICATION_DB_NAME=${{ secrets.DO_PUBLICATION_DB_NAME }} \
          --from-literal=AUTH_DB_HOST=${{ secrets.DO_AUTH_DB_HOST }} \
          --from-literal=AUTH_DB_PORT=${{ secrets.DO_AUTH_DB_PORT }} \
          --from-literal=AUTH_DB_USER=${{ secrets.DO_AUTH_DB_USER }} \
          --from-literal=AUTH_DB_PASSWORD=${{ secrets.DO_AUTH_DB_PASSWORD }} \
          --from-literal=AUTH_DB_NAME=${{ secrets.DO_AUTH_DB_NAME }} \
          --from-literal=PASSPORT_DB_HOST=${{ secrets.DO_PASSPORT_DB_HOST }} \
          --from-literal=PASSPORT_DB_PORT=${{ secrets.DO_PASSPORT_DB_PORT }} \
          --from-literal=PASSPORT_DB_USER=${{ secrets.DO_PASSPORT_DB_USER }} \
          --from-literal=PASSPORT_DB_PASSWORD=${{ secrets.DO_PASSPORT_DB_PASSWORD }} \
          --from-literal=PASSPORT_DB_NAME=${{ secrets.DO_PASSPORT_DB_NAME }} \
          --from-literal=MARKET_DB_HOST=${{ secrets.DO_MARKET_DB_HOST }} \
          --from-literal=MARKET_DB_PORT=${{ secrets.DO_MARKET_DB_PORT }} \
          --from-literal=MARKET_DB_USER=${{ secrets.DO_MARKET_DB_USER }} \
          --from-literal=MARKET_DB_PASSWORD=${{ secrets.DO_MARKET_DB_PASSWORD }} \
          --from-literal=MARKET_DB_NAME=${{ secrets.DO_MARKET_DB_NAME }} \
          --from-literal=EVENTS_DB_HOST=${{ secrets.DO_EVENTS_DB_HOST }} \
          --from-literal=EVENTS_DB_PORT=${{ secrets.DO_EVENTS_DB_PORT }} \
          --from-literal=EVENTS_DB_USER=${{ secrets.DO_EVENTS_DB_USER }} \
          --from-literal=EVENTS_DB_PASSWORD=${{ secrets.DO_EVENTS_DB_PASSWORD }} \
          --from-literal=EVENTS_DB_NAME=${{ secrets.DO_EVENTS_DB_NAME }} \
          --from-literal=RABBITMQ_PASSWORD=${{ secrets.DO_RABBITMQ_PASSWORD }} \
          --from-literal=ACCESS_TOKEN_SECRET=${{ secrets.DO_ACCESS_TOKEN_SECRET }} \
          --from-literal=REFRESH_TOKEN_SECRET=${{ secrets.DO_REFRESH_TOKEN_SECRET }} \
          -n $NAMESPACE

    - name: Create/Update registry pull secret
      run: |
        # Delete existing secret if it exists
        kubectl delete secret registry-backstage-registry-1761508031 -n $NAMESPACE --ignore-not-found=true
        
        # Create registry pull secret
        kubectl create secret docker-registry registry-backstage-registry-1761508031 \
          --docker-server=registry.digitalocean.com \
          --docker-username=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} \
          --docker-password=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} \
          -n $NAMESPACE

    - name: Apply ConfigMap
      run: |
        kubectl apply -f k8s/digitalocean/03-configmap.yaml

    - name: Deploy RabbitMQ
      run: |
        kubectl apply -f k8s/digitalocean/13-rabbitmq-deployment.yaml
        kubectl rollout status deployment/backstage-rabbitmq -n $NAMESPACE --timeout=3m

    - name: Deploy Server
      run: |
        kubectl apply -f k8s/digitalocean/04-server-deployment.yaml
        kubectl rollout status deployment/backstage-server -n $NAMESPACE --timeout=5m

    - name: Deploy Auth
      run: |
        kubectl apply -f k8s/digitalocean/05-auth-deployment.yaml
        kubectl rollout status deployment/backstage-auth -n $NAMESPACE --timeout=5m

    - name: Deploy Passport
      run: |
        kubectl apply -f k8s/digitalocean/08-passport-deployment.yaml
        kubectl rollout status deployment/backstage-passport -n $NAMESPACE --timeout=5m

    - name: Deploy Market
      run: |
        kubectl apply -f k8s/digitalocean/09-market-deployment.yaml
        kubectl rollout status deployment/backstage-market -n $NAMESPACE --timeout=5m

    - name: Deploy Events
      run: |
        kubectl apply -f k8s/digitalocean/10-events-deployment.yaml
        kubectl rollout status deployment/backstage-events -n $NAMESPACE --timeout=5m

    - name: Deploy Notifications
      run: |
        kubectl apply -f k8s/digitalocean/11-notifications-deployment.yaml
        kubectl rollout status deployment/backstage-notifications -n $NAMESPACE --timeout=5m

    - name: Apply Services
      run: |
        kubectl apply -f k8s/digitalocean/06-services-nodeport.yaml

    - name: Apply HPA (Auto-scaling)
      run: |
        kubectl apply -f k8s/digitalocean/07-hpa.yaml

    - name: Check pod status
      run: |
        echo "Current pod status:"
        kubectl get pods -n $NAMESPACE
        echo ""
        echo "Checking for any issues:"
        kubectl describe pods -n $NAMESPACE | grep -A 10 "Events:" || true

    - name: Wait for pods to be ready
      run: |
        echo "Waiting for all pods to be ready..."
        kubectl wait --for=condition=ready pod -l app=backstage-server -n $NAMESPACE --timeout=5m || {
          echo "Server pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-server -n $NAMESPACE
          kubectl describe pods -l app=backstage-server -n $NAMESPACE
          exit 1
        }
        kubectl wait --for=condition=ready pod -l app=backstage-auth -n $NAMESPACE --timeout=5m || {
          echo "Auth pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-auth -n $NAMESPACE
          kubectl describe pods -l app=backstage-auth -n $NAMESPACE
          exit 1
        }
        kubectl wait --for=condition=ready pod -l app=backstage-passport -n $NAMESPACE --timeout=5m || {
          echo "Passport pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-passport -n $NAMESPACE
          kubectl describe pods -l app=backstage-passport -n $NAMESPACE
          exit 1
        }
        kubectl wait --for=condition=ready pod -l app=backstage-market -n $NAMESPACE --timeout=5m || {
          echo "Market pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-market -n $NAMESPACE
          kubectl describe pods -l app=backstage-market -n $NAMESPACE
          exit 1
        }
        kubectl wait --for=condition=ready pod -l app=backstage-events -n $NAMESPACE --timeout=5m || {
          echo "Events pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-events -n $NAMESPACE
          kubectl describe pods -l app=backstage-events -n $NAMESPACE
          exit 1
        }
        kubectl wait --for=condition=ready pod -l app=backstage-rabbitmq -n $NAMESPACE --timeout=3m || {
          echo "RabbitMQ pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-rabbitmq -n $NAMESPACE
          kubectl describe pods -l app=backstage-rabbitmq -n $NAMESPACE
          exit 1
        }
        kubectl wait --for=condition=ready pod -l app=backstage-notifications -n $NAMESPACE --timeout=5m || {
          echo "Notifications pods failed to become ready. Checking status:"
          kubectl get pods -l app=backstage-notifications -n $NAMESPACE
          kubectl describe pods -l app=backstage-notifications -n $NAMESPACE
          exit 1
        }

    - name: Get deployment status
      run: |
        echo "=========================================="
        echo "Deployment Status"
        echo "=========================================="
        kubectl get all -n $NAMESPACE
        echo ""
        echo "=========================================="
        echo "HPA Status"
        echo "=========================================="
        kubectl get hpa -n $NAMESPACE

    - name: Run deployment tests
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      run: |
        cd k8s/digitalocean
        chmod +x test-deployment.sh
        ./test-deployment.sh

    - name: Get access information
      if: success()
      run: |
        NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
        if [ -z "$NODE_IP" ]; then
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
        fi
        
        SERVER_NODEPORT=$(kubectl get service backstage-server-nodeport -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
        AUTH_NODEPORT=$(kubectl get service backstage-auth-nodeport -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
        PASSPORT_NODEPORT=$(kubectl get service backstage-passport-nodeport -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
        MARKET_NODEPORT=$(kubectl get service backstage-market-nodeport -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
        EVENTS_NODEPORT=$(kubectl get service backstage-events-nodeport -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
        
        echo "=========================================="
        echo "Deployment Successful!"
        echo "=========================================="
        echo ""
        echo "Access your services at:"
        echo "  Server API:   http://$NODE_IP:$SERVER_NODEPORT"
        echo "  Auth API:     http://$NODE_IP:$AUTH_NODEPORT"
        echo "  Passport API: http://$NODE_IP:$PASSPORT_NODEPORT"
        echo "  Market API:   http://$NODE_IP:$MARKET_NODEPORT"
        echo "  Events API:   http://$NODE_IP:$EVENTS_NODEPORT"
        echo ""
        echo "Health checks:"
        echo "  curl http://$NODE_IP:$SERVER_NODEPORT/health"
        echo "  curl http://$NODE_IP:$AUTH_NODEPORT/health"
        echo "  curl http://$NODE_IP:$PASSPORT_NODEPORT/health"
        echo "  curl http://$NODE_IP:$MARKET_NODEPORT/health"
        echo "  curl http://$NODE_IP:$EVENTS_NODEPORT/health"

    - name: Deployment failed - Show logs
      if: failure()
      run: |
        echo "=========================================="
        echo "Deployment failed. Showing pod logs..."
        echo "=========================================="
        
        echo "Server logs:"
        kubectl logs -l app=backstage-server -n $NAMESPACE --tail=50 || true
        
        echo ""
        echo "Auth logs:"
        kubectl logs -l app=backstage-auth -n $NAMESPACE --tail=50 || true
        
        echo ""
        echo "Passport logs:"
        kubectl logs -l app=backstage-passport -n $NAMESPACE --tail=20 || true
        
        echo ""
        echo "Market logs:"
        kubectl logs -l app=backstage-market -n $NAMESPACE --tail=20 || true
        
        echo ""
        echo "Events logs:"
        kubectl logs -l app=backstage-events -n $NAMESPACE --tail=20 || true
        
        echo ""
        echo "Recent events:"
        kubectl get events -n $NAMESPACE --sort-by='.lastTimestamp' | tail -20
