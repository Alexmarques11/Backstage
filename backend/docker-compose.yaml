services:
  # Database services - one for each microservice
  publication-database:
    image: postgres:15
    container_name: postgres_publication
    environment:
      POSTGRES_USER: ${DATABASE_USER:-user123}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-123456}
      POSTGRES_DB: publication_db
    ports:
      - "5432:5432"
    volumes:
      - publication_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-user123} -d publication_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-database:
    image: postgres:15
    container_name: postgres_auth
    environment:
      POSTGRES_USER: ${DATABASE_USER:-user123}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-123456}
      POSTGRES_DB: auth_db
    ports:
      - "5433:5432"
    volumes:
      - auth_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-user123} -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  passport-database:
    image: postgres:15
    container_name: postgres_passport
    environment:
      POSTGRES_USER: ${DATABASE_USER:-user123}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-123456}
      POSTGRES_DB: passport_db
    ports:
      - "5434:5432"
    volumes:
      - passport_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-user123} -d passport_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  market-database:
    image: postgres:15
    container_name: postgres_market
    environment:
      POSTGRES_USER: ${DATABASE_USER:-user123}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-123456}
      POSTGRES_DB: market_db
    ports:
      - "5435:5432"
    volumes:
      - market_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-user123} -d market_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  events-database:
    image: postgres:15
    container_name: postgres_events
    environment:
      POSTGRES_USER: ${DATABASE_USER:-user123}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-123456}
      POSTGRES_DB: events_db
    ports:
      - "5436:5432"
    volumes:
      - events_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-user123} -d events_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ message broker
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: backstage_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-backstage}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq123}
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  app:
    build:
      context: .
      dockerfile: publications/Dockerfile
    container_name: backend_app
    ports:
      - "13000:3000"
    depends_on:
      publication-database:
        condition: service_healthy
      auth-database:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PUBLICATION_DB_HOST: publication-database
      PUBLICATION_DB_USER: ${DATABASE_USER:-user123}
      PUBLICATION_DB_PASSWORD: ${DATABASE_PASSWORD:-123456}
      PUBLICATION_DB_NAME: publication_db
      PUBLICATION_DB_PORT: 5432
      AUTH_DB_HOST: auth-database
      AUTH_DB_USER: ${DATABASE_USER:-user123}
      AUTH_DB_PASSWORD: ${DATABASE_PASSWORD:-123456}
      AUTH_DB_NAME: auth_db
      AUTH_DB_PORT: 5432
      DATABASE_SSL: 'false'
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-default_jwt_secret_change_in_production}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-default_refresh_secret_change_in_production}

  auth:
    build:
      context: .
      dockerfile: authentication/Dockerfile
    container_name: auth_server
    ports:
      - "14000:4000"
    depends_on:
      auth-database:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      AUTH_DB_HOST: auth-database
      AUTH_DB_USER: ${DATABASE_USER:-user123}
      AUTH_DB_PASSWORD: ${DATABASE_PASSWORD:-123456}
      AUTH_DB_NAME: auth_db
      AUTH_DB_PORT: 5432
      DATABASE_SSL: 'false'
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-default_jwt_secret_change_in_production}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-default_refresh_secret_change_in_production}

  passport:
    build:
      context: .
      dockerfile: passport/Dockerfile
    container_name: passport_server
    ports:
      - "15000:5000"
    depends_on:
      passport-database:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PASSPORT_DB_HOST: passport-database
      PASSPORT_DB_USER: ${DATABASE_USER:-user123}
      PASSPORT_DB_PASSWORD: ${DATABASE_PASSWORD:-123456}
      PASSPORT_DB_NAME: passport_db
      PASSPORT_DB_PORT: 5432
      DATABASE_SSL: 'false'
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-default_jwt_secret_change_in_production}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-default_refresh_secret_change_in_production}

  market:
    build:
      context: .
      dockerfile: market/Dockerfile
    container_name: market_server
    ports:
      - "16000:6000"
    depends_on:
      market-database:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      MARKET_DB_HOST: market-database
      MARKET_DB_USER: ${DATABASE_USER:-user123}
      MARKET_DB_PASSWORD: ${DATABASE_PASSWORD:-123456}
      MARKET_DB_NAME: market_db
      MARKET_DB_PORT: 5432
      DATABASE_SSL: 'false'
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-default_jwt_secret_change_in_production}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-default_refresh_secret_change_in_production}

  events:
    build:
      context: .
      dockerfile: events/Dockerfile
    container_name: events_server
    ports:
      - "17000:7000"
    depends_on:
      events-database:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      EVENTS_DB_HOST: events-database
      EVENTS_DB_USER: ${DATABASE_USER:-user123}
      EVENTS_DB_PASSWORD: ${DATABASE_PASSWORD:-123456}
      EVENTS_DB_NAME: events_db
      EVENTS_DB_PORT: 5432
      DATABASE_SSL: 'false'
      ACCESS_TOKEN_SECRET: ${ACCESS_TOKEN_SECRET:-default_jwt_secret_change_in_production}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-default_refresh_secret_change_in_production}

volumes:
  publication_data:
  auth_data:
  passport_data:
  market_data:
  events_data:
  rabbitmq_data: